#!/bin/sh

# Ejecutar ESLint
echo "ğŸ” Ejecutando ESLint..."
npm run lint
if [ $? -ne 0 ]; then
    echo "âŒ ESLint fallÃ³. Por favor corrige los problemas antes del commit."
    exit 1
fi

# Ejecutar pruebas con cobertura en formato JSON summary
echo "ğŸ§ª Ejecutando pruebas con cobertura..."
npx jest --config jest.config.cjs --coverage --coverageReporters=json-summary

# Verificar cobertura mÃ­nima usando Node.js para procesar el JSON summary
node -e "
const fs = require('fs');
const path = require('path');

// Leer el archivo de cobertura summary
const coveragePath = path.join(__dirname, 'coverage', 'coverage-summary.json');
const rawData = fs.readFileSync(coveragePath);
const coverageSummary = JSON.parse(rawData);

// Obtener los totales
const totals = coverageSummary.total;

const thresholds = {
  lines: 70,
  statements: 70,
  branches: 60,
  functions: 60
};

let failed = false;

for (const [key, threshold] of Object.entries(thresholds)) {
  const coverageValue = totals[key]?.pct;
  if (coverageValue === undefined) {
    console.error(\`âŒ No se encontraron datos de cobertura para \${key}\`);
    failed = true;
  } else if (coverageValue < threshold) {
    console.error(\`âŒ Cobertura de \${key} estÃ¡ por debajo del mÃ­nimo: \${coverageValue}% < \${threshold}%\`);
    failed = true;
  } else {
    console.log(\`âœ… Cobertura de \${key}: \${coverageValue}% >= \${threshold}%\`);
  }
}

process.exit(failed ? 1 : 0);
"

if [ $? -ne 0 ]; then
    echo "âŒ VerificaciÃ³n de cobertura fallÃ³. Por favor mejora la cobertura de pruebas antes del commit."
    exit 1
fi

# Verificar formateo con Prettier (nueva adiciÃ³n)
echo "ğŸ’… Ejecutando verificaciÃ³n de Prettier..."
npm run prettier:check
if [ $? -ne 0 ]; then
    echo "âŒ VerificaciÃ³n de Prettier fallÃ³. Ejecuta 'npm run prettier:fix' para formatear tu cÃ³digo."
    exit 1
fi

echo "âœ… Â¡Todas las verificaciones pasaron! Procediendo con el commit..."